## BallSelector 球筛选器工作原理详解

### 一、整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        BallSelector 球筛选器                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  输入：多个检测到的球                                                 │
│    ↓                                                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │
│  │  球历史记录  │  │  静止球黑名单 │  │ 其他球场球  │  ← 三大过滤机制  │
│  │ BallHistory │  │  Blacklist  │  │ OtherCourt │                 │
│  └─────────────┘  └─────────────┘  └─────────────┘                 │
│         ↓                ↓                ↓                        │
│  ┌─────────────────────────────────────────────────────────┐       │
│  │                    候选球评分系统                         │       │
│  │  置信度 + 运动历史 + 距离 + 裁剪框位置 → 综合得分         │       │
│  └─────────────────────────────────────────────────────────┘       │
│    ↓                                                                │
│  输出：得分最高的目标球（或无）                                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 二、三大数据结构

#### 1. 球历史记录 `BallHistory`

**作用**：记录每个球的运动轨迹，判断是静止球还是运动球

```cpp
struct BallHistory {
    float cx, cy;              // 当前位置
    float initial_cx, initial_cy; // 初始位置（用于判断是否移动过）
    float total_movement;      // 累计移动距离
    int static_count;          // 连续静止帧数
    int last_seen_frame;       // 最后看到的帧
    int first_seen_frame;      // 首次看到的帧
    bool is_static;            // 当前是否静止
    bool ever_moved;           // 是否曾经移动过（关键！）
    int id;                    // 唯一ID
    float avg_vx, avg_vy;      // 平均速度
    int velocity_samples;      // 速度采样数
};
```

**判断逻辑**：
```
                    初始位置
                       ●
                       │
          移动距离 > 30px？
                       │
        ┌──── 是 ─────┴───── 否 ────┐
        ▼                           ▼
   ever_moved = true         ever_moved = false
   (曾经运动过)               (从未运动过 → 可能是干扰球)
```

---

#### 2. 静止球黑名单 `StaticBlacklistEntry`

**作用**：记录长期静止不动的球位置，后续检测到直接过滤

```cpp
struct StaticBlacklistEntry {
    float cx, cy;           // 黑名单位置
    float radius;           // 匹配半径（默认60px）
    int added_frame;        // 加入时的帧号
    int last_seen_frame;    // 最后确认的帧号
    float confidence;       // 置信度（多次确认会增加）
};
```

**加入黑名单条件**：
```
连续静止 60 帧 + 从未移动过 → 加入黑名单
```

**图示**：
```
┌────────────────────────────────────────┐
│                                        │
│    ⚽ ← 静止60帧，从未动过              │
│    ╳                                   │
│   紫色标记                              │
│   加入黑名单                            │
│   后续在此位置检测到的球直接忽略         │
│                                        │
└────────────────────────────────────────┘
```

---

#### 3. 其他球场球 `OtherCourtBall`

**作用**：识别并过滤相邻球场的运动球

```cpp
struct OtherCourtBall {
    float cx, cy;           // 位置
    float vx, vy;           // 速度
    int first_seen_frame;   // 首次看到
    int last_seen_frame;    // 最后看到
    int confirm_count;      // 确认次数
    bool is_confirmed;      // 是否已确认
    int id;                 // 关联的球历史ID
};
```

**判断条件**：
```
1. 距离主目标 > 400px
2. 球在运动（ever_moved = true）
3. 运动方向与主目标不同（夹角 > 45°）
4. 连续确认 30 帧
```

**图示**：
```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   主球场                          │    相邻球场             │
│                                   │                        │
│      ⚽ ─→ 主目标                 │       ⚽ ←─ 其他球场球  │
│      向右移动                      │       向左移动          │
│                                   │       方向相反！        │
│                                   │       标记为干扰        │
│                                   │                        │
└─────────────────────────────────────────────────────────────┘
```

---

### 三、筛选流程

```
select_target_ball() 被调用
           │
           ▼
┌─────────────────────────┐
│ 1. 更新球历史记录        │  ← 记录每个球的位置、运动状态
│    update_all_ball_history │
└─────────────────────────┘
           │
           ▼
┌─────────────────────────┐
│ 2. 更新静止球黑名单      │  ← 把长期静止的球加入黑名单
│    update_static_blacklist │
└─────────────────────────┘
           │
           ▼
┌─────────────────────────┐
│ 3. 更新其他球场球        │  ← 识别相邻球场的干扰球
│    update_other_court_balls │
└─────────────────────────┘
           │
           ▼
     检测到几个球？
           │
    ┌──────┴──────┐
    │             │
   0个           1个            多个
    │             │              │
    ▼             ▼              ▼
handle_no_    process_      process_multiple_
detection()  single_        detections()
             detection()
```

---

### 四、单球处理流程

```cpp
const T_DetectObject* process_single_detection(const T_DetectObject& det)
```

```
检测到 1 个球
      │
      ▼
┌─────────────────┐
│ 在黑名单中？     │──── 是 ────→ 返回 nullptr（忽略）
└─────────────────┘
      │ 否
      ▼
┌─────────────────┐
│ 是其他球场球？   │──── 是 ────→ 返回 nullptr（忽略）
└─────────────────┘
      │ 否
      ▼
┌─────────────────┐
│ 在有效区域内？   │──── 否 ────→ 返回 nullptr（忽略）
└─────────────────┘
      │ 是
      ▼
┌─────────────────┐
│ 是可接受目标？   │──── 否 ────→ 返回 nullptr（忽略）
│ (没有长期静止)   │
└─────────────────┘
      │ 是
      ▼
┌─────────────────┐
│ 保护期检查       │  如果之前跟踪的是运动球，
│                 │  且刚丢失不久，拒绝静止球
└─────────────────┘
      │ 通过
      ▼
   返回该球 ✓
```

---

### 五、多球处理流程

```cpp
const T_DetectObject* process_multiple_detections(...)
```

```
检测到多个球
      │
      ▼
┌─────────────────────────────────────────┐
│ 对每个球创建候选对象 BallCandidate       │
│ 收集：位置、静止状态、是否在裁剪框内等    │
└─────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────┐
│ 过滤无效候选：                           │
│ - 在黑名单中                            │
│ - 是其他球场球                          │
│ - 长期静止从未运动                       │
│ - 不在有效区域                          │
└─────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────┐
│ 对每个有效候选计算优先级得分              │
│ calculate_priority()                    │
└─────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────┐
│ 按得分排序，选择最高分                   │
└─────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────┐
│ 检查最高分是否可接受                     │
│ is_acceptable_best_candidate()          │
└─────────────────────────────────────────┘
      │
      ▼
   返回得分最高的球 ✓
```

---

### 六、优先级评分系统

```cpp
float calculate_priority(const BallCandidate& candidate, bool has_tracker)
```

| 评分项 | 条件 | 分数 |
|--------|------|------|
| **置信度** | YOLO检测置信度 | `+score × 100` |
| **跟踪器距离** | 距离跟踪预测位置 < 500px | `+(500 - dist) × 0.5` |
| **运动历史** | 曾经运动过 | `+350` |
| **静止惩罚** | 当前静止中 | `-静止帧数 × 5` |
| **从未运动** | 静止 > 5帧 | `-400` |
| **从未运动** | 静止 > 15帧 | `-300`（累加） |
| **目标连续性** | 距上帧目标 < 150px | `+(150 - dist) × 2` |
| **目标连续性** | 距上帧目标 > 300px | `-(dist - 300) × 0.5` |
| **目标切换保护** | 距离 > 250px 且刚丢失 | `-800` |
| **裁剪框内** | 在裁剪框区域内 | `+300` |
| **裁剪框外** | 距中心 > 400px | `-150` |
| **裁剪框外** | 距中心 > 800px | `-250`（累加） |
| **裁剪框外** | 距中心 > 1200px | `-350`（累加） |
| **其他球场** | 疑似其他球场球 | `-500` |

---

### 七、评分示例

```
场景：3个球同时被检测到

球A：裁剪框内，运动中，距上帧目标100px
    +80 (置信度0.8)
    +350 (运动过)
    +100 (距上帧近)
    +300 (裁剪框内)
    ─────────────
    总分：830 ✓ 最高

球B：裁剪框外800px，静止20帧，从未运动
    +75 (置信度0.75)
    -100 (静止20帧 × 5)
    -400 (从未运动>5帧)
    -300 (从未运动>15帧)
    -250 (裁剪框外>800px)
    ─────────────
    总分：-975 ✗

球C：其他球场，运动方向相反
    +85 (置信度0.85)
    +350 (运动过)
    -500 (其他球场球)
    -350 (裁剪框外>1200px)
    ─────────────
    总分：-415 ✗

结果：选择球A
```

---

### 八、状态管理

#### 目标锁定状态

```cpp
bool has_locked_target_;           // 是否有锁定目标
int frames_since_target_lost_;     // 丢失目标多少帧了
float last_target_cx_, last_target_cy_;  // 上帧目标位置
float last_target_vx_, last_target_vy_;  // 目标速度（用于预测）
bool target_was_moving_;           // 之前跟踪的是运动球吗
int consecutive_track_frames_;     // 连续跟踪了多少帧
```

#### 目标丢失时的行为

```cpp
void handle_no_detection()
{
    frames_since_target_lost_++;
    
    // 用速度预测目标位置
    last_target_cx_ += last_target_vx_;
    last_target_cy_ += last_target_vy_;
    
    // 速度衰减
    last_target_vx_ *= 0.85f;
    last_target_vy_ *= 0.85f;
    
    // 丢失太久后重置运动状态
    if (frames_since_target_lost_ > 40) {
        target_was_moving_ = false;
    }
}
```

---

### 九、一句话总结

**BallSelector 通过历史记录识别静止干扰球和其他球场球，用评分系统从多个候选中选出最可能是目标的球，优先选择运动中的、在裁剪框内的、距离上帧目标近的球。**